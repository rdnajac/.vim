#!/usr/bin/env -S nvim -l

local uv = vim.uv
local PWD = os.getenv('PWD') or uv.cwd()
local NVIM_PIPE = os.getenv('NVIM_PIPE') or (os.getenv('XDG_RUNTIME_DIR') or '/tmp') .. '/nvim.pipe'

local function resolve(path)
  return uv.fs_realpath(path) or (PWD .. '/' .. path)
end

local args = {}
for i = 1, #arg do
  local a = arg[i]
  if a:sub(1, 1) == '-' then
    if a == '-d' then
      print('Deleting ' .. NVIM_PIPE)
      return vim.fs.rm(NVIM_PIPE)
    end
    table.insert(args, a)
  else
    table.insert(args, resolve(a))
  end
end

vim.print(vim.inspect(args))

local NVIM = os.getenv('NVIM')
local stat = uv.fs_stat(NVIM_PIPE)

local cmd = ''
if stat and stat.type == 'socket' then
  cmd = string.format('nvim --server %q --remote %s', NVIM_PIPE, table.concat(args, ' '))
elseif NVIM and NVIM ~= '' then
  cmd = string.format('nvim --server %q --remote %s', NVIM, table.concat(args, ' '))
else
  cmd = string.format('nvim --listen %q %s', NVIM_PIPE, table.concat(args, ' '))
end

return os.exit(os.execute(cmd))
