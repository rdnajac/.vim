if exists('g:loaded_emoji')
  finish
endif

function! s:to_candidate(emoji)
  return has_key(a:emoji, 'emoji') ? {
        \ 'emoji': a:emoji['emoji'],
        \ 'word': a:emoji['aliases'][0],
        \ 'kind': a:emoji['emoji'] . ' ',
        \ 'menu': a:emoji['description'],
        \ 'icase': 1,
        \ 'dup': 1
        \ } : {}
endfunction

let s:emoji_path = expand('~/.vim/.emoji.json')
let s:emoji_file = 'https://raw.githubusercontent.com/github/gemoji/master/db/emoji.json'

function! emoji#complete()
  if !exists('s:emojis')
    if !filereadable(s:emoji_path)
      echo "Downloading emojis..."
      silent! execute '!' . 'curl -L -o ' . s:emoji_path . ' ' . s:emoji_file
      if v:shell_error
        echo "Failed to download emoji.json"
        return ""
      endif
    endif
    let s:emojis = map(json_decode(readfile(s:emoji_path)), 's:to_candidate(v:val)')
  endif
  let line = getline('.')[ : col('.')-1]
  let s:complete_start = match(line, '\w*$')
  if s:complete_start >= 0
    call complete(s:complete_start+1, s:emojis)
    return "\<c-p>"
  endif
  return ""
endfunction

inoremap <silent><expr> <c-e> emoji#complete()

autocmd CompleteDone <buffer> unlet! s:emojis

" original credit: kyuhi/vim-emoji-complete
" vim: set ft=vim:

